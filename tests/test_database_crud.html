<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database CRUD Test - Health Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .test-button { margin: 5px; padding: 10px 15px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .test-button:hover { background: #2563eb; }
        .test-button:disabled { background: #9ca3af; cursor: not-allowed; }
        .result { margin: 10px 0; padding: 10px; border-radius: 6px; }
        .error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; }
        .success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #16a34a; }
        .info { background: #eff6ff; border: 1px solid #bfdbfe; color: #2563eb; }
        .warning { background: #fffbeb; border: 1px solid #fed7aa; color: #d97706; }
        .log { background: #f8fafc; border: 1px solid #e2e8f0; color: #475569; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Database CRUD Test - Health Tracker</h1>
        
        <!-- Test Status -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">Test Status</h2>
            <div id="testStatus" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                    <div class="font-medium">Backend Status</div>
                    <div id="backendStatus" class="text-sm">Checking...</div>
                </div>
                <div class="p-3 bg-green-50 border border-green-200 rounded">
                    <div class="font-medium">Authentication</div>
                    <div id="authStatus" class="text-sm">Not tested</div>
                </div>
                <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <div class="font-medium">User Registration</div>
                    <div id="registrationStatus" class="text-sm">Not tested</div>
                </div>
                <div class="p-3 bg-purple-50 border border-purple-200 rounded">
                    <div class="font-medium">Health Records</div>
                    <div id="recordsStatus" class="text-sm">Not tested</div>
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="flex flex-wrap gap-2">
                <button onclick="testBackendHealth()" class="test-button">Test Backend Health</button>
                <button onclick="testUserRegistration()" class="test-button">Test User Registration</button>
                <button onclick="testUserLogin()" class="test-button">Test User Login</button>
                <button onclick="testCreateHealthRecord()" class="test-button">Test Create Record</button>
                <button onclick="testUpdateHealthRecord()" class="test-button">Test Update Record</button>
                <button onclick="testDeleteHealthRecord()" class="test-button">Test Delete Record</button>
                <button onclick="testGetAllRecords()" class="test-button">Test Get All Records</button>
                <button onclick="testUserProfileUpdate()" class="test-button">Test Profile Update</button>
                <button onclick="runAllTests()" class="test-button bg-green-600 hover:bg-green-700">Run All Tests</button>
                <button onclick="clearResults()" class="test-button bg-gray-600 hover:bg-gray-700">Clear Results</button>
            </div>
        </div>

        <!-- Test Results -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="testResults" class="space-y-4"></div>
        </div>

        <!-- Test Data -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">Test Data</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium mb-2">User Data</h3>
                    <div id="userData" class="text-sm bg-gray-50 p-3 rounded"></div>
                </div>
                <div>
                    <h3 class="font-medium mb-2">Health Record Data</h3>
                    <div id="recordData" class="text-sm bg-gray-50 p-3 rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = null;
        let testUserId = null;
        let testRecordId = null;
        let testUserData = {
            email: `test_${Date.now()}@healthtracker.com`,
            name: 'Test User',
            password: 'TestPassword123!'
        };
        let testRecordData = {
            date: new Date().toISOString().split('T')[0],
            weight: 75.5,
            height: 180,
            age: 30,
            body_fat_percentage: 15.2,
            body_fat_kg: 11.5,
            muscle_mass: 60.0,
            bone_mass: 3.2,
            bmi: 23.3,
            kcal: 2500,
            metabolic_age: 28,
            water_percentage: 65.0,
            visceral_fat: 5,
            fat_right_arm: 2.5,
            fat_left_arm: 2.5,
            fat_right_leg: 4.0,
            fat_left_leg: 4.0,
            fat_trunk: 8.0
        };

        // API Base URL
        const API_BASE = 'http://localhost:3000/api';

        // Utility functions
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const logDiv = document.createElement('div');
            logDiv.className = `result ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(logDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateStatus(elementId, status, color = 'blue') {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.className = `text-sm text-${color}-600`;
        }

        function updateTestData() {
            document.getElementById('userData').textContent = JSON.stringify(testUserData, null, 2);
            document.getElementById('recordData').textContent = JSON.stringify(testRecordData, null, 2);
        }

        // Test functions
        async function testBackendHealth() {
            log('Testing backend health...', 'info');
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… Backend is healthy and running', 'success');
                    updateStatus('backendStatus', 'Online', 'green');
                } else {
                    log('âŒ Backend health check failed', 'error');
                    updateStatus('backendStatus', 'Offline', 'red');
                }
            } catch (error) {
                log(`âŒ Backend connection error: ${error.message}`, 'error');
                updateStatus('backendStatus', 'Connection Failed', 'red');
            }
        }

        async function testUserRegistration() {
            log('Testing user registration...', 'info');
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testUserData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… User registration successful', 'success');
                    log(`User ID: ${data.user.id}`, 'info');
                    testUserId = data.user.id;
                    updateStatus('registrationStatus', 'Success', 'green');
                } else {
                    log(`âŒ Registration failed: ${data.error}`, 'error');
                    updateStatus('registrationStatus', 'Failed', 'red');
                }
            } catch (error) {
                log(`âŒ Registration error: ${error.message}`, 'error');
                updateStatus('registrationStatus', 'Error', 'red');
            }
        }

        async function testUserLogin() {
            log('Testing user login...', 'info');
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: testUserData.email,
                        password: testUserData.password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    log('âœ… User login successful', 'success');
                    log(`Token received: ${authToken.substring(0, 20)}...`, 'info');
                    updateStatus('authStatus', 'Authenticated', 'green');
                } else {
                    log(`âŒ Login failed: ${data.error}`, 'error');
                    updateStatus('authStatus', 'Failed', 'red');
                }
            } catch (error) {
                log(`âŒ Login error: ${error.message}`, 'error');
                updateStatus('authStatus', 'Error', 'red');
            }
        }

        async function testCreateHealthRecord() {
            if (!authToken) {
                log('âŒ Authentication required for creating health record', 'error');
                return;
            }

            log('Testing health record creation...', 'info');
            try {
                const response = await fetch(`${API_BASE}/health-records`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(testRecordData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    testRecordId = data.record.id;
                    log('âœ… Health record created successfully', 'success');
                    log(`Record ID: ${testRecordId}`, 'info');
                    updateStatus('recordsStatus', 'Created', 'green');
                } else {
                    log(`âŒ Create record failed: ${data.error}`, 'error');
                    updateStatus('recordsStatus', 'Failed', 'red');
                }
            } catch (error) {
                log(`âŒ Create record error: ${error.message}`, 'error');
                updateStatus('recordsStatus', 'Error', 'red');
            }
        }

        async function testUpdateHealthRecord() {
            if (!authToken || !testRecordId) {
                log('âŒ Authentication and record ID required for updating', 'error');
                return;
            }

            log('Testing health record update...', 'info');
            try {
                const updateData = { ...testRecordData, weight: 76.0, bmi: 23.5 };
                
                const response = await fetch(`${API_BASE}/health-records/${testRecordId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… Health record updated successfully', 'success');
                    log(`Updated weight: ${data.record.weight}kg`, 'info');
                    updateStatus('recordsStatus', 'Updated', 'green');
                } else {
                    log(`âŒ Update record failed: ${data.error}`, 'error');
                    updateStatus('recordsStatus', 'Failed', 'red');
                }
            } catch (error) {
                log(`âŒ Update record error: ${error.message}`, 'error');
                updateStatus('recordsStatus', 'Error', 'red');
            }
        }

        async function testDeleteHealthRecord() {
            if (!authToken || !testRecordId) {
                log('âŒ Authentication and record ID required for deletion', 'error');
                return;
            }

            log('Testing health record deletion...', 'info');
            try {
                const response = await fetch(`${API_BASE}/health-records/${testRecordId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… Health record deleted successfully', 'success');
                    testRecordId = null;
                    updateStatus('recordsStatus', 'Deleted', 'green');
                } else {
                    log(`âŒ Delete record failed: ${data.error}`, 'error');
                    updateStatus('recordsStatus', 'Failed', 'red');
                }
            } catch (error) {
                log(`âŒ Delete record error: ${error.message}`, 'error');
                updateStatus('recordsStatus', 'Error', 'red');
            }
        }

        async function testGetAllRecords() {
            if (!authToken) {
                log('âŒ Authentication required for getting records', 'error');
                return;
            }

            log('Testing get all health records...', 'info');
            try {
                const response = await fetch(`${API_BASE}/health-records`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`âœ… Retrieved ${data.records.length} health records`, 'success');
                    updateStatus('recordsStatus', `${data.records.length} records`, 'green');
                } else {
                    log(`âŒ Get records failed: ${data.error}`, 'error');
                    updateStatus('recordsStatus', 'Failed', 'red');
                }
            } catch (error) {
                log(`âŒ Get records error: ${error.message}`, 'error');
                updateStatus('recordsStatus', 'Error', 'red');
            }
        }

        async function testUserProfileUpdate() {
            if (!authToken) {
                log('âŒ Authentication required for profile update', 'error');
                return;
            }

            log('Testing user profile update...', 'info');
            try {
                const newName = `Updated Test User ${Date.now()}`;
                
                const response = await fetch(`${API_BASE}/users/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ name: newName })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… User profile updated successfully', 'success');
                    log(`New name: ${data.user.name}`, 'info');
                    updateStatus('registrationStatus', 'Profile Updated', 'green');
                } else {
                    log(`âŒ Profile update failed: ${data.error}`, 'error');
                    updateStatus('registrationStatus', 'Failed', 'red');
                }
            } catch (error) {
                log(`âŒ Profile update error: ${error.message}`, 'error');
                updateStatus('registrationStatus', 'Error', 'red');
            }
        }

        async function runAllTests() {
            log('ðŸš€ Starting comprehensive CRUD test suite...', 'info');
            
            // Reset status
            updateStatus('backendStatus', 'Testing...', 'yellow');
            updateStatus('authStatus', 'Testing...', 'yellow');
            updateStatus('registrationStatus', 'Testing...', 'yellow');
            updateStatus('recordsStatus', 'Testing...', 'yellow');
            
            // Run tests in sequence
            await testBackendHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testUserRegistration();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testUserLogin();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCreateHealthRecord();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testGetAllRecords();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testUpdateHealthRecord();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testUserProfileUpdate();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDeleteHealthRecord();
            
            log('ðŸŽ‰ All tests completed!', 'success');
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            log('Results cleared', 'info');
        }

        // Initialize
        window.onload = function() {
            updateTestData();
            testBackendHealth();
        };
    </script>
</body>
</html> 