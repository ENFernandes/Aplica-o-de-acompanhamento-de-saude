<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Height Population</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        label { display: block; margin: 5px 0; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Test Height Population from User Profile</h1>
    
    <div class="test-section">
        <h3>1. Current User Profile</h3>
        <button onclick="getUserProfile()">Get User Profile</button>
        <div id="profile-result"></div>
    </div>

    <div class="test-section">
        <h3>2. Test Height Field Population</h3>
        <label for="test-height">Height Field:</label>
        <input type="number" id="test-height" name="height" placeholder="Should be populated from profile">
        <button onclick="populateHeight()">Populate Height</button>
        <div id="height-result"></div>
    </div>

    <div class="test-section">
        <h3>3. Test Age Field Population</h3>
        <label for="test-age">Age Field:</label>
        <input type="number" id="test-age" name="age" placeholder="Should be calculated from birthday">
        <button onclick="populateAge()">Populate Age</button>
        <div id="age-result"></div>
    </div>

    <div class="test-section">
        <h3>4. Test Profile Banner</h3>
        <div id="profile-info-banner" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm text-blue-800">
                    <span id="profile-height-info" class="hidden">Altura: <strong id="profile-height-value"></strong> cm</span>
                    <span id="profile-age-info" class="hidden ml-4">Idade: <strong id="profile-age-value"></strong> anos</span>
                </span>
            </div>
        </div>
        <button onclick="updateBanner()">Update Banner</button>
        <div id="banner-result"></div>
    </div>

    <script>
        let currentUser = null;

        async function getUserProfile() {
            const resultDiv = document.getElementById('profile-result');
            try {
                const token = localStorage.getItem('auth-token');
                if (!token) {
                    resultDiv.innerHTML = `<div class="result error">❌ No auth token found. Please login first.</div>`;
                    return;
                }

                const response = await fetch('http://localhost:3000/api/users/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    currentUser = data.user;
                    resultDiv.innerHTML = `<div class="result success">✅ User profile loaded: ${JSON.stringify(currentUser)}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="result error">❌ Failed to get profile: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">❌ Error: ${error.message}</div>`;
            }
        }

        function populateHeight() {
            const resultDiv = document.getElementById('height-result');
            const heightInput = document.getElementById('test-height');
            
            if (!currentUser) {
                resultDiv.innerHTML = `<div class="result error">❌ No user data. Get profile first.</div>`;
                return;
            }

            if (currentUser.height) {
                heightInput.value = currentUser.height;
                heightInput.readOnly = true;
                heightInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                resultDiv.innerHTML = `<div class="result success">✅ Height populated: ${currentUser.height} cm</div>`;
            } else {
                heightInput.placeholder = 'Defina a sua altura no perfil';
                resultDiv.innerHTML = `<div class="result error">❌ No height in profile</div>`;
            }
        }

        function populateAge() {
            const resultDiv = document.getElementById('age-result');
            const ageInput = document.getElementById('test-age');
            
            if (!currentUser) {
                resultDiv.innerHTML = `<div class="result error">❌ No user data. Get profile first.</div>`;
                return;
            }

            if (currentUser.birthday) {
                const age = calculateAgeFromBirthday(currentUser.birthday);
                if (age !== null) {
                    ageInput.value = age;
                    ageInput.readOnly = true;
                    ageInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                    resultDiv.innerHTML = `<div class="result success">✅ Age calculated: ${age} years</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="result error">❌ Could not calculate age from birthday</div>`;
                }
            } else {
                ageInput.placeholder = 'Defina a sua data de nascimento no perfil';
                resultDiv.innerHTML = `<div class="result error">❌ No birthday in profile</div>`;
            }
        }

        function calculateAgeFromBirthday(birthday) {
            if (!birthday) return null;
            
            const today = new Date();
            const birthDate = new Date(birthday);
            
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        function updateBanner() {
            const resultDiv = document.getElementById('banner-result');
            const banner = document.getElementById('profile-info-banner');
            const heightInfo = document.getElementById('profile-height-info');
            const ageInfo = document.getElementById('profile-age-info');
            const heightValue = document.getElementById('profile-height-value');
            const ageValue = document.getElementById('profile-age-value');
            
            if (!currentUser) {
                resultDiv.innerHTML = `<div class="result error">❌ No user data. Get profile first.</div>`;
                return;
            }

            let hasInfo = false;
            
            // Show height info
            if (currentUser.height) {
                heightInfo.classList.remove('hidden');
                heightValue.textContent = currentUser.height;
                hasInfo = true;
            }
            
            // Show age info
            if (currentUser.birthday) {
                const age = calculateAgeFromBirthday(currentUser.birthday);
                if (age !== null) {
                    ageInfo.classList.remove('hidden');
                    ageValue.textContent = age;
                    hasInfo = true;
                }
            }
            
            // Show banner if we have any info
            if (hasInfo) {
                banner.classList.remove('hidden');
                resultDiv.innerHTML = `<div class="result success">✅ Banner updated with profile info</div>`;
            } else {
                resultDiv.innerHTML = `<div class="result error">❌ No profile info to display</div>`;
            }
        }

        // Auto-test on load
        window.onload = function() {
            getUserProfile();
        };
    </script>
</body>
</html> 