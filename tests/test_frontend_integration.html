<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Integration Test - Health Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .test-button { margin: 5px; padding: 10px 15px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .test-button:hover { background: #2563eb; }
        .test-button:disabled { background: #9ca3af; cursor: not-allowed; }
        .result { margin: 10px 0; padding: 10px; border-radius: 6px; }
        .error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; }
        .success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #16a34a; }
        .info { background: #eff6ff; border: 1px solid #bfdbfe; color: #2563eb; }
        .warning { background: #fffbeb; border: 1px solid #fed7aa; color: #d97706; }
        .iframe-container { width: 100%; height: 600px; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
        .iframe-container iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Frontend Integration Test - Health Tracker</h1>
        
        <!-- Test Status -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">Test Status</h2>
            <div id="testStatus" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                    <div class="font-medium">Application Status</div>
                    <div id="appStatus" class="text-sm">Loading...</div>
                </div>
                <div class="p-3 bg-green-50 border border-green-200 rounded">
                    <div class="font-medium">Form Validation</div>
                    <div id="validationStatus" class="text-sm">Not tested</div>
                </div>
                <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <div class="font-medium">Data Submission</div>
                    <div id="submissionStatus" class="text-sm">Not tested</div>
                </div>
                <div class="p-3 bg-purple-50 border border-purple-200 rounded">
                    <div class="font-medium">UI Updates</div>
                    <div id="uiStatus" class="text-sm">Not tested</div>
                </div>
            </div>
        </div>

        <!-- Application Frame -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">Application Interface</h2>
            <div class="iframe-container">
                <iframe id="appFrame" src="../index.html" title="Health Tracker Application"></iframe>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="flex flex-wrap gap-2">
                <button onclick="testAppLoad()" class="test-button">Test App Load</button>
                <button onclick="testFormValidation()" class="test-button">Test Form Validation</button>
                <button onclick="testDataSubmission()" class="test-button">Test Data Submission</button>
                <button onclick="testRecordEditing()" class="test-button">Test Record Editing</button>
                <button onclick="testRecordDeletion()" class="test-button">Test Record Deletion</button>
                <button onclick="testUIUpdates()" class="test-button">Test UI Updates</button>
                <button onclick="testErrorHandling()" class="test-button">Test Error Handling</button>
                <button onclick="runAllFrontendTests()" class="test-button bg-green-600 hover:bg-green-700">Run All Frontend Tests</button>
                <button onclick="generateReport()" class="test-button bg-purple-600 hover:bg-purple-700">Generate Report</button>
                <button onclick="clearResults()" class="test-button bg-gray-600 hover:bg-gray-700">Clear Results</button>
            </div>
        </div>

        <!-- Test Results -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="testResults" class="space-y-4 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- Test Data -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4">Test Data</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium mb-2">Valid Test Data</h3>
                    <div id="validData" class="text-sm bg-gray-50 p-3 rounded"></div>
                </div>
                <div>
                    <h3 class="font-medium mb-2">Invalid Test Data</h3>
                    <div id="invalidData" class="text-sm bg-gray-50 p-3 rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let appFrame = null;
        let testResults = [];
        let testStartTime = null;
        let testEndTime = null;
        let testData = {
            valid: {
                weight: 75.5,
                height: 180,
                age: 30,
                bodyFatPercentage: 15.2,
                bodyFatKg: 11.5,
                muscleMass: 60.0,
                boneMass: 3.2,
                bmi: 23.3,
                kcal: 2500,
                metabolicAge: 28,
                waterPercentage: 65.0,
                visceralFat: 5
            },
            invalid: {
                weight: -5,
                height: 0,
                age: 150,
                bodyFatPercentage: 150,
                bodyFatKg: -10,
                muscleMass: 200,
                boneMass: -5,
                bmi: 0,
                kcal: -1000,
                metabolicAge: 0,
                waterPercentage: 200,
                visceralFat: -5
            }
        };

        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultsDiv = document.getElementById('testResults');
            const logDiv = document.createElement('div');
            logDiv.className = `result ${type}`;
            logDiv.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
            resultsDiv.appendChild(logDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            // Store result for report
            testResults.push({
                timestamp,
                message,
                type,
                status: type === 'success' ? 'PASS' : type === 'error' ? 'FAIL' : 'INFO'
            });
        }

        function updateStatus(elementId, status, color = 'blue') {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.className = `text-sm text-${color}-600`;
        }

        function updateTestData() {
            document.getElementById('validData').textContent = JSON.stringify(testData.valid, null, 2);
            document.getElementById('invalidData').textContent = JSON.stringify(testData.invalid, null, 2);
        }

        function getAppFrame() {
            return document.getElementById('appFrame');
        }

        function waitForElement(selector, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                const checkElement = () => {
                    const element = getAppFrame().contentDocument.querySelector(selector);
                    if (element) {
                        resolve(element);
                    } else if (Date.now() - startTime > timeout) {
                        reject(new Error(`Element ${selector} not found within ${timeout}ms`));
                    } else {
                        setTimeout(checkElement, 100);
                    }
                };
                checkElement();
            });
        }

        // Test functions
        async function testAppLoad() {
            log('Testing application load...', 'info');
            try {
                const frame = getAppFrame();
                
                // Wait for frame to load
                await new Promise((resolve) => {
                    frame.onload = resolve;
                });

                // Check if main elements are present
                const mainElements = [
                    'form#health-form',
                    'table tbody#history-table-body',
                    'button[type="submit"]'
                ];

                let allElementsFound = true;
                for (const selector of mainElements) {
                    try {
                        await waitForElement(selector, 2000);
                        log(`‚úÖ Found element: ${selector}`, 'success');
                    } catch (error) {
                        log(`‚ùå Element not found: ${selector}`, 'error');
                        allElementsFound = false;
                    }
                }

                if (allElementsFound) {
                    log('‚úÖ Application loaded successfully', 'success');
                    updateStatus('appStatus', 'Loaded', 'green');
                } else {
                    log('‚ùå Application load incomplete', 'error');
                    updateStatus('appStatus', 'Incomplete', 'red');
                }
            } catch (error) {
                log(`‚ùå Application load error: ${error.message}`, 'error');
                updateStatus('appStatus', 'Failed', 'red');
            }
        }

        async function testFormValidation() {
            log('Testing form validation...', 'info');
            try {
                const frame = getAppFrame();
                const form = await waitForElement('form#health-form');
                
                // Test with invalid data
                const invalidInputs = [
                    { name: 'weight', value: testData.invalid.weight },
                    { name: 'height', value: testData.invalid.height },
                    { name: 'age', value: testData.invalid.age }
                ];

                for (const input of invalidInputs) {
                    const inputElement = form.querySelector(`input[name="${input.name}"]`);
                    if (inputElement) {
                        inputElement.value = input.value;
                        inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        // Check for validation error
                        await new Promise(resolve => setTimeout(resolve, 100));
                        const errorElement = frame.contentDocument.querySelector(`[data-error="${input.name}"]`);
                        
                        if (errorElement) {
                            log(`‚úÖ Validation error shown for ${input.name}`, 'success');
                        } else {
                            log(`‚ùå No validation error for ${input.name}`, 'error');
                        }
                    }
                }

                updateStatus('validationStatus', 'Tested', 'green');
            } catch (error) {
                log(`‚ùå Form validation error: ${error.message}`, 'error');
                updateStatus('validationStatus', 'Failed', 'red');
            }
        }

        async function testDataSubmission() {
            log('Testing data submission...', 'info');
            try {
                const frame = getAppFrame();
                const form = await waitForElement('form#health-form');
                
                // Fill form with valid data
                const validInputs = [
                    { name: 'weight', value: testData.valid.weight },
                    { name: 'height', value: testData.valid.height },
                    { name: 'age', value: testData.valid.age },
                    { name: 'bodyFatPercentage', value: testData.valid.bodyFatPercentage },
                    { name: 'bodyFatKg', value: testData.valid.bodyFatKg },
                    { name: 'muscleMass', value: testData.valid.muscleMass },
                    { name: 'boneMass', value: testData.valid.boneMass },
                    { name: 'bmi', value: testData.valid.bmi },
                    { name: 'kcal', value: testData.valid.kcal },
                    { name: 'metabolicAge', value: testData.valid.metabolicAge },
                    { name: 'waterPercentage', value: testData.valid.waterPercentage },
                    { name: 'visceralFat', value: testData.valid.visceralFat }
                ];

                for (const input of validInputs) {
                    const inputElement = form.querySelector(`input[name="${input.name}"]`);
                    if (inputElement) {
                        inputElement.value = input.value;
                        inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }

                // Submit form
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.click();
                    
                    // Wait for submission response
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Check for success message or table update
                    const successMessage = frame.contentDocument.querySelector('.success-message, .alert-success');
                    const tableRows = frame.contentDocument.querySelectorAll('table tbody tr');
                    
                    if (successMessage || tableRows.length > 0) {
                        log('‚úÖ Data submission successful', 'success');
                        updateStatus('submissionStatus', 'Success', 'green');
                    } else {
                        log('‚ùå Data submission failed or no feedback', 'error');
                        updateStatus('submissionStatus', 'Failed', 'red');
                    }
                } else {
                    log('‚ùå Submit button not found', 'error');
                    updateStatus('submissionStatus', 'Failed', 'red');
                }
            } catch (error) {
                log(`‚ùå Data submission error: ${error.message}`, 'error');
                updateStatus('submissionStatus', 'Error', 'red');
            }
        }

        async function testRecordEditing() {
            log('Testing record editing...', 'info');
            try {
                const frame = getAppFrame();
                
                // Find edit button in table
                const editButton = await waitForElement('.edit-btn');
                
                if (editButton) {
                    editButton.click();
                    
                    // Wait for edit form to appear
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Check if form is in edit mode
                    const editForm = frame.contentDocument.querySelector('form#health-form');
                    const editInputs = frame.contentDocument.querySelectorAll('td[contenteditable="true"]');
                    
                    if (editForm || editInputs.length > 0) {
                        log('‚úÖ Edit mode activated', 'success');
                        
                        // Modify a field
                        const weightInput = frame.contentDocument.querySelector('input[name="weight"]');
                        if (weightInput) {
                            const originalValue = weightInput.value;
                            weightInput.value = parseFloat(originalValue) + 1;
                            weightInput.dispatchEvent(new Event('input', { bubbles: true }));
                            
                            // Submit edit
                            const saveButton = frame.contentDocument.querySelector('.save-btn');
                            if (saveButton) {
                                saveButton.click();
                                
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                log('‚úÖ Record edit submitted', 'success');
                            }
                        }
                        
                        updateStatus('uiStatus', 'Edit Tested', 'green');
                    } else {
                        log('‚ùå Edit mode not activated', 'error');
                        updateStatus('uiStatus', 'Edit Failed', 'red');
                    }
                } else {
                    log('‚ùå Edit button not found', 'error');
                    updateStatus('uiStatus', 'Edit Failed', 'red');
                }
            } catch (error) {
                log(`‚ùå Record editing error: ${error.message}`, 'error');
                updateStatus('uiStatus', 'Error', 'red');
            }
        }

        async function testRecordDeletion() {
            log('Testing record deletion...', 'info');
            try {
                const frame = getAppFrame();
                
                // Find delete button in table
                const deleteButton = await waitForElement('.delete-btn');
                
                if (deleteButton) {
                    // Store initial row count
                    const initialRows = frame.contentDocument.querySelectorAll('table tbody tr').length;
                    
                    deleteButton.click();
                    
                    // Wait for confirmation dialog
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Confirm deletion
                    const confirmButton = frame.contentDocument.querySelector('#modal-confirm-btn');
                    if (confirmButton) {
                        confirmButton.click();
                        
                        // Wait for deletion to complete
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Check if row was removed
                        const newRows = frame.contentDocument.querySelectorAll('table tbody tr').length;
                        
                        if (newRows < initialRows) {
                            log('‚úÖ Record deleted successfully', 'success');
                            updateStatus('uiStatus', 'Delete Success', 'green');
                        } else {
                            log('‚ùå Record deletion failed', 'error');
                            updateStatus('uiStatus', 'Delete Failed', 'red');
                        }
                    } else {
                        log('‚ùå Confirmation dialog not found', 'error');
                        updateStatus('uiStatus', 'Delete Failed', 'red');
                    }
                } else {
                    log('‚ùå Delete button not found', 'error');
                    updateStatus('uiStatus', 'Delete Failed', 'red');
                }
            } catch (error) {
                log(`‚ùå Record deletion error: ${error.message}`, 'error');
                updateStatus('uiStatus', 'Error', 'red');
            }
        }

        async function testUIUpdates() {
            log('Testing UI updates...', 'info');
            try {
                const frame = getAppFrame();
                
                // Check for dynamic UI elements
                const uiElements = [
                    '.loading-spinner',
                    '.success-message',
                    '.error-message',
                    '.data-table',
                    '.chart-container'
                ];
                
                let uiElementsFound = 0;
                for (const selector of uiElements) {
                    const element = frame.contentDocument.querySelector(selector);
                    if (element) {
                        uiElementsFound++;
                        log(`‚úÖ Found UI element: ${selector}`, 'success');
                    }
                }
                
                if (uiElementsFound > 0) {
                    log(`‚úÖ Found ${uiElementsFound} UI elements`, 'success');
                    updateStatus('uiStatus', `${uiElementsFound} elements`, 'green');
                } else {
                    log('‚ùå No UI elements found', 'error');
                    updateStatus('uiStatus', 'No elements', 'red');
                }
            } catch (error) {
                log(`‚ùå UI updates error: ${error.message}`, 'error');
                updateStatus('uiStatus', 'Error', 'red');
            }
        }

        async function testErrorHandling() {
            log('Testing error handling...', 'info');
            try {
                const frame = getAppFrame();
                
                // Try to submit invalid data
                const form = await waitForElement('form#health-form');
                
                // Fill with invalid data
                const invalidInputs = [
                    { name: 'weight', value: 'abc' },
                    { name: 'height', value: 'xyz' },
                    { name: 'age', value: 'invalid' }
                ];
                
                for (const input of invalidInputs) {
                    const inputElement = form.querySelector(`input[name="${input.name}"]`);
                    if (inputElement) {
                        inputElement.value = input.value;
                        inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
                
                // Try to submit
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.click();
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Check for error messages
                    const errorMessages = frame.contentDocument.querySelectorAll('.error-message, .alert-error, .validation-error');
                    
                    if (errorMessages.length > 0) {
                        log('‚úÖ Error handling working correctly', 'success');
                        updateStatus('validationStatus', 'Errors Handled', 'green');
                    } else {
                        log('‚ùå No error messages displayed', 'error');
                        updateStatus('validationStatus', 'No Errors', 'red');
                    }
                }
            } catch (error) {
                log(`‚ùå Error handling test error: ${error.message}`, 'error');
                updateStatus('validationStatus', 'Error', 'red');
            }
        }

        async function runAllFrontendTests() {
            testStartTime = new Date();
            testResults = [];
            
            log('üöÄ Starting comprehensive frontend integration test suite...', 'info');
            
            // Reset status
            updateStatus('appStatus', 'Testing...', 'yellow');
            updateStatus('validationStatus', 'Testing...', 'yellow');
            updateStatus('submissionStatus', 'Testing...', 'yellow');
            updateStatus('uiStatus', 'Testing...', 'yellow');
            
            // Run tests in sequence
            await testAppLoad();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testFormValidation();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDataSubmission();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testRecordEditing();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUIUpdates();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testErrorHandling();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testRecordDeletion();
            
            testEndTime = new Date();
            log('üéâ All frontend tests completed!', 'success');
            
            // Auto-generate report
            setTimeout(() => generateReport(), 1000);
        }

        function generateReport() {
            if (testResults.length === 0) {
                log('‚ùå No test results available for report generation', 'error');
                return;
            }

            const duration = testEndTime ? Math.round((testEndTime - testStartTime) / 1000) : 0;
            const passCount = testResults.filter(r => r.status === 'PASS').length;
            const failCount = testResults.filter(r => r.status === 'FAIL').length;
            const infoCount = testResults.filter(r => r.status === 'INFO').length;
            const totalTests = passCount + failCount;

            const report = `HEALTH TRACKER FRONTEND INTEGRATION TEST REPORT
================================================================

Test Execution Summary:
- Test Start Time: ${testStartTime ? testStartTime.toLocaleString() : 'N/A'}
- Test End Time: ${testEndTime ? testEndTime.toLocaleString() : 'N/A'}
- Total Duration: ${duration} seconds
- Total Tests: ${totalTests}
- Passed: ${passCount}
- Failed: ${failCount}
- Info Messages: ${infoCount}
- Success Rate: ${totalTests > 0 ? Math.round((passCount / totalTests) * 100) : 0}%

Test Environment:
- Application URL: ../index.html
- Test Interface: Iframe Integration
- Browser: ${navigator.userAgent}

Detailed Test Results:
${testResults.map(result => `[${result.timestamp}] [${result.status}] ${result.message}`).join('\n')}

Frontend Features Tested:
- Application Loading: iframe integration and DOM access
- Form Validation: input validation and error handling
- Data Submission: form submission and API integration
- Record Editing: edit functionality and data updates
- Record Deletion: delete functionality and UI updates
- UI Updates: dynamic content updates and state management
- Error Handling: validation errors and user feedback

Test Data Used:
- Valid Data: ${JSON.stringify(testData.valid, null, 2)}
- Invalid Data: ${JSON.stringify(testData.invalid, null, 2)}

Status Summary:
- Application Status: ${document.getElementById('appStatus').textContent}
- Form Validation Status: ${document.getElementById('validationStatus').textContent}
- Data Submission Status: ${document.getElementById('submissionStatus').textContent}
- UI Updates Status: ${document.getElementById('uiStatus').textContent}

Frontend Integration Coverage:
- User Interface: Form inputs, buttons, tables, alerts
- User Interactions: Click events, form submissions, data entry
- Data Flow: Frontend to backend communication
- Error Handling: Validation and user feedback
- State Management: UI updates and data persistence

Recommendations:
${failCount > 0 ? '- Review failed tests and fix identified UI issues' : '- All frontend tests passed successfully'}
${passCount > 0 ? '- Frontend integration is functioning correctly' : '- No successful tests recorded'}

Report Generated: ${new Date().toLocaleString()}
================================================================`;

            // Create and save the report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `health-tracker-frontend-test-report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Also save to reports directory via server
            try {
                const formData = new FormData();
                formData.append('report', blob, `health-tracker-frontend-test-report-${new Date().toISOString().split('T')[0]}.txt`);
                
                fetch('/save-report', {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (response.ok) {
                        log('üìÑ Frontend test report saved to reports directory successfully', 'success');
                    } else {
                        log('‚ö†Ô∏è Report downloaded but could not save to reports directory', 'warning');
                    }
                }).catch(error => {
                    log('‚ö†Ô∏è Report downloaded but server save failed: ' + error.message, 'warning');
                });
            } catch (error) {
                log('‚ö†Ô∏è Report downloaded but server save failed: ' + error.message, 'warning');
            }

            log('üìÑ Frontend test report generated and downloaded successfully', 'success');
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
            log('Results cleared', 'info');
        }

        // Initialize
        window.onload = function() {
            updateTestData();
            testAppLoad();
        };
    </script>
</body>
</html> 